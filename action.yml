name: 'Gas Comparison Action'
description: 'Compares gas usage in Solidity projects using Foundry and comments the changes on the PR'
inputs:
  token:
    description: 'GitHub token'
    required: true
  base_ref:
    description: 'Base branch reference'
    required: true
  head_ref:
    description: 'Head branch reference'
    required: true
outputs:
  comparison:
    description: 'Gas comparison message'
runs:
  using: 'composite'
  steps:
    - name: Checkout PR branch
      uses: actions/checkout@v2
      with:
        ref: ${{ inputs.head_ref }}
        fetch-depth: 0

    - name: Checkout base branch
      run: |
        git fetch origin ${{ inputs.base_ref }}
        git checkout ${{ inputs.base_ref }}
      shell: bash

    - name: Save base branch .gas-snapshot
      run: cp .gas-snapshot .gas-snapshot-base
      shell: bash

    - name: Switch back to PR branch
      run: git checkout ${{ inputs.head_ref }}
      shell: bash

    - name: Compare gas snapshots
      id: compare_gas_snapshots
      run: |
        output=$(python ${{ github.action_path }}/scripts/compare_gas_snapshots.py .gas-snapshot-base .gas-snapshot)
        comparison=$(echo $output | jq -r '.comparison')
        echo "COMPARISON=$comparison" >> $GITHUB_ENV
      shell: bash

    - name: Comment on PR
      uses: peter-evans/create-or-update-comment@v1
      with:
        GITHUB_TOKEN: ${{ inputs.token }}
        issue-number: ${{ github.event.pull_request.number }}
        body: |
          <!-- gas-comparison-action -->
          ${{ steps.compare_gas_snapshots.outputs.comparison }}
